<!DOCTYPE HTML>
<html>

<head>
    <title>Data</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <script src="../../libraries/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.12.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.13.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.8.0"></script>
    <style>
        .center {
            top: 50%;
            left: 25%;
        }
    </style>
</head>

<body class="is-preload">
    <header id="header">
        <h1>Delay discounting results</h1>
        <p id="subject">Subject: </p>
        <p id="auc">AUC: </p>
    </header>
    <div id="main">
        <div id="indiff_curve" style="width:100%;height:100%;"></div>
        </section>
    </div>

    <script type="text/javascript">
        // retrieve objects from sessionStorage
        datasummary = sessionStorage.getObj("datasummary_delaydiscount_");
        info = sessionStorage.getObj("info_");

        var auc = datasummary.auc.toFixed(4);
        var subject_id = info.subject;
        var id_header = document.getElementById("subject");
        id_header.textContent += subject_id;
        var auc_header = document.getElementById("auc");
        auc_header.textContent += auc;

        console.log('subject id: ' + subject_id);
        console.log('datasummary_')
        console.log(datasummary)
    </script>

    <div id="vis" class="center"></div>

    <script type="text/javascript">
        // console.log(datasummary.data);
        var indiff_curve = {
            config: { axis: { labelFontSize: 18, titleFontSize: 21 }, title: { fontSize: 28 }, legend: { labelFontSize: 30 } },
            "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
            data: {
                // values: datasummary.data.filter(i => i.n_trial == (datasummary.trials_per_cost - 1))
                values: datasummary.data
            },
            transform: [
                { filter: "datum.n_trial == " + (datasummary.trials_per_cost - 1).toString() + "" },
                { calculate: "datum.indifference/datum.large_reward", as: "indifference" }
            ],
            mark: { type: "point", tooltip: true, filled: true },
            encoding: {
                x: { field: "cost", type: "quantitative", axis: { "title": "Delay (days to reward)", labelAlign: "center" } },
                y: { field: "indifference", type: "quantitative", scale: { domain: [0, 1] }, axis: { "title": "Subjective value" } },
                size: { value: 233 }
            },
            title: "Individual discounting curve",
            width: 550,
            height: 400,
        };
        vegaEmbed('#vis', indiff_curve, { theme: "vox" });
    </script>

    <div id="vis2" class="center"></div>

    <script type="text/javascript">
        // console.log(datasummary.data);
        console.log("Total Entries: " + <%= data.length %>);
        console.log("Queried Data:");
        data = <%- JSON.stringify(data) %>;
        console.log(data);
        data_array = <%- JSON.stringify(data_array) %>;
        console.log(data_array);

        var aggregate_curve = {
            config: { axis: { labelFontSize: 18, titleFontSize: 21 }, title: { fontSize: 28 }, legend: { labelFontSize: 30 } },
            "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
            data: { values: data_array },
            transform: [
                { filter: "datum.n_trial == " + (datasummary.trials_per_cost - 1).toString() + "" },
                { calculate: "datum.indifference/datum.large_reward", as: "indifference" }
            ],
            encoding: {
                x: {
                    field: "cost",
                    type: "quantitative",
                    axis: { "title": "Delay (days to reward)" }
                },
            },
            layer: [
                {
                    mark: {
                        type: "boxplot",
                        extent: 1.5
                    },
                    encoding: {
                        y: {
                            field: "indifference",
                            type: "quantitative",
                            axis: { "title": "Subjective Value" }
                        },
                        size: { value: 5 }
                    },

                },
                {
                    mark: {
                        type: "line",
                    },
                    encoding: {
                        y: {
                            field: "indifference",
                            type: "quantitative",
                            axis: { "title": "Subjective Value" },
                            aggregate: "median",
                        },
                        size: { value: 3 }
                    },
                    transform: [
                        {
                            regression: "indifference",
                            on: "cost",
                            method: "log"
                        }
                    ]
                },
                {
                    mark: { type: "point", tooltip: true, filled: true },
                    encoding: {
                        y: { field: "indifference", type: "quantitative", scale: { domain: [0, 1] }, axis: { "title": "Subjective value" } },
                        size: { value: 233 }
                    }
                }],
            title: "Aggregate discounting curve",
            width: 550,
            height: 400,
        };
        vegaEmbed('#vis2', aggregate_curve, { theme: "vox" });
    </script>

    <div id="vis3" class="center"></div>

    <script type="text/javascript">
        var auc_histogram = {
            config: { axis: { labelFontSize: 18, titleFontSize: 21 }, title: { fontSize: 28 }, legend: { labelFontSize: 30 } },
            "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
            data: { values: data_array },
            transform: [
                { filter: "datum.trial_index == 0" },
            ],
            mark: { type: "bar"},
            encoding: {
                x: {
                    type: "quantitative",
                    bin: true,
                    field: "auc",
                },
                y: {
                    aggregate: "count",
                    scale: {
                        round: true
                    }
                }
            },
            title: "Aggregate AUC histogram",
            width: 550,
            height: 400,
        };
        vegaEmbed('#vis3', auc_histogram, { theme: "vox" });
    </script>


</body>

</html>